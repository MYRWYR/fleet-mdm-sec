<div id="software" v-cloak>
  <div purpose="page-content" class="container-fluid">
    <div class="d-flex flex-column">
      <div class="pb-4 d-flex flex-row justify-content-between">
        <div>
        <h3 purpose="page-heading" @click="clickChangeTeamFilter(9)">Software</h3>
        </div>
        <div class="d-flex flex-row align-items-center">
          <p class="mb-0 mr-2">Team:</p>
          <select class="custom-select team-select" v-model="teamFilter" @change="changeTeamFilter()">
            <option :value="undefined" selected>All teams</option>
            <option v-for="team of teams" :value="team.fleetApid">{{team.teamName}}</option>
          </select>
        </div>
      </div>
    </div>
    <div class="d-flex flex-row justify-content-between pb-3">
      <div>
        <p><strong>Software</strong></p>
      </div>
      <div>
        <p style="color: #6A67FE; cursor: pointer;" @click="clickOpenAddSoftwareModal()">+ Add software</p>
      </div>
    </div>
    <div style="overflow-y: visible;" class="mb-4 border rounded table-responsive-md" v-if="softwareToDisplay.length > 0">
      <table class="table my-0">
        <thead>
          <tr>
            <th class="sortable" :class="sortDirection === 'ASC' ? 'ascending' : sortDirection === 'DESC' ? 'descending' : ''" @click="clickChangeSortDirection()">
              <div style="cursor: pointer;" class="d-flex flex-row align-items-center pointer">
                <small><strong>Name</strong></small>
                <div class="sort-arrows">
                  <span class="ascending-arrow"></span>
                  <span class="descending-arrow"></span>
                </div>
              </div>
            </th>
            <th>
              <small><strong>Platform</strong></small>
            </th>
            <th v-if="teamFilter === undefined">
              <span><small><strong>Team</strong></small></span>
            </th>
            <th>
              <span><small><strong>Upload date</strong></small></span>
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="software in softwareToDisplay" :key="software.id">
            <td class="name-column">{{software.name}}</td>
            <td>{{software.platform}}</td>
            <td v-if="teamFilter === undefined">
              <a class="affected-teams-link" v-if="software.teams && software.teams.length > 0">
                <span class="truncated-affected-teams" v-if="software.teams.length > 1">
                  {{software.teams.length}} teams
                  <div class="teams-tooltip">
                    <p v-for="team in software.teams" @click="clickChangeTeamFilter(team.fleetApid)">{{team.teamName}}</p>
                  </div>
                </span>
                <span v-else @click="clickChangeTeamFilter(software.teams[0].fleetApid)">
                  {{software.teams[0].teamName}}
                </span>
              </a>
              <span v-else>---</span>
            </td>
            <td>
              <js-timestamp :at="software.createdAt" format="timeago"></js-timestamp>
            </td>
            <td>
              <div class="d-flex flex-row align-items-start justify-content-end">
                <img style="height: 16px; margin-right: 24px;" alt="download" class="pointer" src="/images/download-16x16@2x.png" @click="clickDownloadSoftware(software)">
                <img style="height: 16px; margin-right: 24px;" alt="edit" class="pointer" src="/images/edit-pencil-16x21@2x.png" @click="clickOpenEditModal(software)">
                <img style="height: 16px" alt="delete" class="pointer" src="/images/delete-16x21@2x.png" @click="clickOpenDeleteModal(software)">
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div v-else>
      <h3 class="px-3 text-center mx-auto pt-5">No software matching the selected filters were found.</h3>
    </div>
  </div>
  <modal v-if="modal === 'edit-software'" hide-close-button="true" @close="closeModal()">
    <div>
      <div class="d-flex flex-row justify-content-between">
        <h3 class="mb-4">Edit software</h3>
        <div class="pointer" @click="closeModal()">&times;</div>
      </div>
      <ajax-form action="editSoftware" :syncing.sync="syncing" :cloud-error.sync="cloudError" :form-errors.sync="formErrors" :form-data="formData" :form-rules="editSoftwareFormRules" @submitted="submittedForm()">
        <div purpose="software-information" v-if="!formData.newSoftwares">
          <div class="d-flex flex-row justify-content-start">
            <img style="height: 40px; width: 34px;" alt="Windows software" src="/images/software-icon-ps1-34x40@2x.png" v-if="softwareToEdit.platform === 'Windows'">
            <img style="height: 40px; width: 34px;" alt="macOs and Linux software" src="/images/software-icon-sh-34x40@2x.png" v-else>
            <div class="d-flex flex-column">
              <p><strong>{{softwareToEdit.name}}</strong></p>
              <p class="muted">{{softwareToEdit.platform}}</p>
            </div>
          </div>
        </div>
        <file-upload id="edit-file-upload" mode="softwares" :disabled="syncing" accept=".xml,.mobileconfig" v-model="formData.newSoftware"></file-upload>
        <div purpose="teams-picker" class="mt-4">
          <p class="mb-2"><strong>Teams</strong></p>
          <multifield :value="formData.teams" v-model="formData.newTeamIds" input-type="teamSelect" :select-options="teams" add-button-text="Add team"></multifield>
        </div>
        <cloud-error v-if="cloudError === 'softwareNameDoesNotMatch'">The new software file name identifier must match the old softwares’ file name.</cloud-error>
        <cloud-error v-else-if="cloudError"></cloud-error>
        <div purpose="modal-buttons" class="d-flex flex-row justify-content-end align-items-center">
          <ajax-button :syncing.sync="syncing" purpose="modal-button" type="submit">Save</ajax-button>
        </div>
      </ajax-form>
    </div>
  </modal>
  <%//  ╔╦╗╔═╗╦  ╔═╗╔╦╗╔═╗  ╔═╗╔═╗╦═╗╦╔═╗╔╦╗
    //   ║║║╣ ║  ║╣  ║ ║╣   ╚═╗║  ╠╦╝║╠═╝ ║
    //  ═╩╝╚═╝╩═╝╚═╝ ╩ ╚═╝  ╚═╝╚═╝╩╚═╩╩   ╩ %>
  <modal v-if="modal === 'delete-software'" hide-close-button="true" @close="closeModal()">
    <div class="d-flex flex-row justify-content-between">
      <h3 class="mb-4">Delete software</h3>
      <div class="pointer" @click="closeModal()">&times;</div>
    </div>
    <p class="mb-2">Delete this software from all teams.</p>
    <p>This will cancel the software from running.</p>
    <ajax-form :handle-submitting="handleSubmittingDeleteSoftwareForm" :syncing.sync="syncing" :cloud-error.sync="cloudError" :form-errors.sync="formErrors" :form-data="formData" :form-rules="editSoftwareFormRules" @submitted="submittedForm()">
      <cloud-error v-if="cloudError"></cloud-error>
    <div class="d-flex flex-row justify-content-end align-items-center">
      <a class="mr-3" style="color: #D66C7B; cursor: pointer;" @click="closeModal()">Cancel</a>
      <ajax-button class="btn" purpose="delete-button" :syncing.sync="syncing">Delete</ajax-button>
    </div>
    </ajax-form>
  </modal>
  <%//  ╔═╗╔╦╗╔╦╗  ╔═╗╔═╗╦═╗╦╔═╗╔╦╗
    //  ╠═╣ ║║ ║║  ╚═╗║  ╠╦╝║╠═╝ ║
    //  ╩ ╩═╩╝═╩╝  ╚═╝╚═╝╩╚═╩╩   ╩ %>
  <modal v-if="modal === 'add-software'" hide-close-button="true" @close="closeModal()">
    <div>
      <div class="d-flex flex-row justify-content-between">
        <h3 class="mb-4">Add software</h3>
        <div class="pointer" @click="closeModal()">&times;</div>
      </div>
      <ajax-form :handle-submitting="handleSubmittingAddSoftwareForm" :syncing.sync="syncing" :cloud-error.sync="cloudError" :form-errors.sync="formErrors" :form-data="formData" :form-rules="addSoftwareFormRules" @submitted="submittedForm()">
        <file-upload id="file-upload" :class="[formErrors.newSoftware ? 'is-invalid' : '']"  mode="software" :disabled="syncing" v-model="formData.newSoftware"></file-upload>
        <div class="invalid-feedback text-center" v-if="formErrors.newSoftware">Please upload a new software.</div>
        <div purpose="teams-picker" class="mt-4">
          <p class="mb-2"><strong>Teams</strong></p>
          <multifield :value="formData.teams" v-model="formData.teams" input-type="teamSelect" :select-options="teams" add-button-text="Add team"></multifield>
        </div>
        <div class="invalid-feedback text-center" v-if="formErrors.teams">Please select the teams you want to deploy this software to.</div>
        <cloud-error v-if="cloudError && cloudError === 'softwareWithThisNameAlreadyExists'">A software with the same name as the uploaded software already exists on one or more of the selected teams.</cloud-error>
        <cloud-error v-else-if="cloudError"></cloud-error>
        <div purpose="modal-buttons" class="d-flex flex-row justify-content-end align-items-center">
          <a purpose="cancel-button" @click="closeModal()">Cancel</a>
          <ajax-button :syncing.sync="syncing" purpose="modal-button" :disabled="!formData.newSoftware"  type="submit">Add</ajax-button>
        </div>
      </ajax-form>
    </div>
  </modal>
</div>
<%- /* Expose server-rendered data as window.SAILS_LOCALS :: */ exposeLocalsToBrowser() %>
